<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>World Weather Map</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#3da8f5",
            "background-light": "#f5f7f8",
            "background-dark": "#020617",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px",
          },
          boxShadow: {
            glow: "0 0 25px rgba(59,130,246,0.55)",
          },
        },
      },
    };
  </script>

  <!-- Google fonts / icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&display=swap"
    rel="stylesheet"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    .material-symbols-outlined {
      font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
    }
    body {
      min-height: max(884px, 100dvh);
    }
    /* Make Leaflet map fill its container */
    #map {
      width: 100%;
      height: 100%;
    }

    /* Fancy emoji marker */
    .marker-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 9999px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #0f172a);
      box-shadow: 0 6px 16px rgba(0,0,0,0.6);
      border: 1px solid rgba(148,163,184,0.9);
      font-size: 1.3rem;
    }

    /* Animated gradient background */
    .bg-animated {
      background-size: 200% 200%;
      animation: bgMotion 18s ease-in-out infinite;
    }

    @keyframes bgMotion {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }
  </style>
</head>
<body class="font-display">
  <div
    class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden"
  >
    <!-- Time-based gradient background -->
    <div
      id="bgGradient"
      class="absolute inset-0 bg-animated"
    ></div>

    <div class="@container flex flex-col h-full flex-1 relative">
      <!-- Header -->
      <header
        class="flex w-full items-start justify-between p-4 pt-8 sm:p-6 z-10 relative"
      >
        <div class="flex flex-col gap-1">
          <h1 id="pageTitle" class="text-xl font-bold text-[#f9fafb] drop-shadow">
            World Weather
          </h1>
          <p
            id="greetingText"
            class="text-sm font-medium text-[#e5e7eb]/90"
          >
            Good Morning
          </p>
        </div>
        <div
          id="timeEmoji"
          class="text-5xl drop-shadow"
        >
          ‚òÄÔ∏è
        </div>
      </header>

      <!-- Map + controls -->
      <div
        class="flex flex-1 flex-col px-4 pt-4 pb-3 @[480px]:px-4 @[480px]:py-3 relative z-10"
      >
        <div
          class="relative flex min-h-[480px] flex-1 flex-col justify-between rounded-2xl overflow-hidden shadow-2xl border border-white/20 backdrop-blur-xl bg-white/5"
        >
          <!-- Leaflet map -->
          <div id="map" class="absolute inset-0"></div>

          <!-- Top overlay: search + quick focus pills -->
          <div class="relative z-10 flex flex-col justify-between h-full">
            <div class="p-4 pt-3 sm:p-6 sm:pt-4 space-y-3">
              <label class="flex flex-col min-w-40 h-12">
                <div
                  class="flex w-full flex-1 items-stretch rounded-full h-full shadow-md shadow-black/40 ring-1 ring-white/30 bg-white/80 backdrop-blur-sm"
                >
                  <div
                    class="text-[#424242]/80 flex border-none bg-transparent items-center justify-center pl-4 rounded-l-full border-r-0"
                  >
                    <span class="material-symbols-outlined">search</span>
                  </div>
                  <input
                    id="searchInput"
                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-r-full text-[#111827] focus:outline-0 focus:ring-0 border-none bg-transparent focus:border-none h-full placeholder:text-[#6b7280] px-4 pl-2 text-base font-normal leading-normal"
                    placeholder="Search city (e.g., London, Johannesburg, Durban...)"
                  />
                </div>
              </label>

              <!-- Quick focus chips -->
              <div class="flex gap-2 flex-wrap text-xs">
                <button
                  id="focusWorld"
                  class="px-3 py-1 rounded-full bg-white/75 hover:bg-white text-gray-800 shadow-sm transition"
                >
                  üåç Full World
                </button>
                <button
                  id="focusSA"
                  class="px-3 py-1 rounded-full bg-white/75 hover:bg-white text-gray-800 shadow-sm transition"
                >
                  üáøüá¶ South Africa
                </button>
                <button
                  id="focusIndia"
                  class="px-3 py-1 rounded-full bg-white/75 hover:bg-white text-gray-800 shadow-sm transition"
                >
                  üáÆüá≥ India
                </button>
              </div>
            </div>

            <!-- Bottom-right: zoom & locate controls -->
            <div class="flex flex-col items-end gap-3 p-4 sm:p-6">
              <div class="flex flex-col gap-0.5 rounded-xl overflow-hidden shadow-lg shadow-black/50">
                <button
                  id="btnZoomIn"
                  class="flex size-10 items-center justify-center bg-white/85 backdrop-blur-md hover:bg-white transition"
                >
                  <div class="text-[#111827]">
                    <span class="material-symbols-outlined">add</span>
                  </div>
                </button>
                <button
                  id="btnZoomOut"
                  class="flex size-10 items-center justify-center bg-white/85 backdrop-blur-md hover:bg-white transition"
                >
                  <div class="text-[#111827]">
                    <span class="material-symbols-outlined">remove</span>
                  </div>
                </button>
              </div>
              <button
                id="btnLocate"
                class="flex size-10 items-center justify-center rounded-xl bg-white/85 backdrop-blur-md hover:bg-white shadow-lg shadow-black/50 transition"
              >
                <div class="text-[#111827]">
                  <span class="material-symbols-outlined">my_location</span>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom info card (selected city) -->
      <div class="px-4 pb-8 sm:px-6 relative z-10">
        <div
          class="relative rounded-2xl bg-white/80 backdrop-blur-xl p-4 shadow-xl border border-white/70 overflow-hidden"
        >
          <div
            class="pointer-events-none absolute inset-0 bg-gradient-to-r from-blue-400/15 via-amber-400/10 to-purple-500/15 opacity-80"
          ></div>
          <div class="relative flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <div
                id="infoEmoji"
                class="text-4xl drop-shadow"
              >
                üåç
              </div>
              <div>
                <p
                  id="infoCity"
                  class="font-bold text-[#111827]"
                >
                  Select a city on the map
                </p>
                <p
                  id="infoStatus"
                  class="text-sm text-[#4b5563]"
                >
                  Live weather will appear here.
                </p>
              </div>
            </div>
            <div class="text-right">
              <p
                id="infoTemp"
                class="text-3xl font-bold text-[#111827]"
              >
                --¬∞C
              </p>
              <p
                id="infoFeels"
                class="text-sm text-[#6b7280]"
              >
                Feels like --
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    // =========================
    // Time-based theme
    // =========================
    function getCurrentTheme() {
      const hour = new Date().getHours();
      if (hour >= 6 && hour < 12) {
        return {
          name: "morning",
          gradient:
            "linear-gradient(135deg, #87CEEB, #E0F7FA, #a5b4fc)",
          emoji: "‚òÄÔ∏è",
          greeting: "Good Morning",
          docTitle: "World Weather Map - Morning",
          tileUrl: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        };
      } else if (hour >= 12 && hour < 18) {
        return {
          name: "evening",
          gradient:
            "linear-gradient(135deg, #FFCF87, #FF9A00, #fb7185)",
          emoji: "üåá",
          greeting: "Good Evening",
          docTitle: "World Weather Map - Evening",
          tileUrl: "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
        };
      } else {
        return {
          name: "night",
          gradient:
            "radial-gradient(circle at top, #0f172a, #020617, #000000)",
          emoji: "üåô",
          greeting: "Good Night",
          docTitle: "World Weather Map - Night",
          tileUrl:
            "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
        };
      }
    }

    const theme = getCurrentTheme();

    // Apply background gradient
    const bg = document.getElementById("bgGradient");
    bg.style.backgroundImage = theme.gradient;

    // Header text / emoji
    document.getElementById("greetingText").textContent = theme.greeting;
    const timeEmojiEl = document.getElementById("timeEmoji");
    timeEmojiEl.textContent = theme.emoji;
    document.title = theme.docTitle;

    // =========================
    // City data
    // =========================

    // Global main cities
    const baseCities = [
      { id: "delhi",    name: "Delhi",        country: "India",      lat: 28.6139,  lon: 77.2090 },
      { id: "mumbai",   name: "Mumbai",       country: "India",      lat: 19.0760,  lon: 72.8777 },
      { id: "london",   name: "London",       country: "UK",         lat: 51.5074,  lon: -0.1278 },
      { id: "nyc",      name: "New York",     country: "USA",        lat: 40.7128,  lon: -74.0060 },
      { id: "tokyo",    name: "Tokyo",        country: "Japan",      lat: 35.6762,  lon: 139.6503 },
      { id: "moscow",   name: "Moscow",       country: "Russia",     lat: 55.7558,  lon: 37.6173 },
      { id: "sydney",   name: "Sydney",       country: "Australia",  lat: -33.8688, lon: 151.2093 },
      { id: "sp",       name: "S√£o Paulo",    country: "Brazil",     lat: -23.5505, lon: -46.6333 },
      { id: "cairo",    name: "Cairo",        country: "Egypt",      lat: 30.0444,  lon: 31.2357 },
      { id: "chennai",  name: "Chennai",      country: "India",      lat: 13.0827,  lon: 80.2707 },
      { id: "bengaluru",name: "Bengaluru",    country: "India",      lat: 12.9716,  lon: 77.5946 },
    ];

    // South Africa cities you provided
    const southAfricaCities = [
      {"id":"johannesburg","name":"Johannesburg","country":"South Africa","lat":-26.2044,"lon":28.0456},
      {"id":"capetown","name":"Cape Town","country":"South Africa","lat":-33.9253,"lon":18.4239},
      {"id":"soweto","name":"Soweto","country":"South Africa","lat":-26.2678,"lon":27.8585},
      {"id":"gqeberha","name":"Gqeberha","country":"South Africa","lat":-33.9581,"lon":25.6},
      {"id":"pietermaritzburg","name":"Pietermaritzburg","country":"South Africa","lat":-29.6167,"lon":30.3833},
      {"id":"durban","name":"Durban","country":"South Africa","lat":-29.8833,"lon":31.05},
      {"id":"pretoria","name":"Pretoria","country":"South Africa","lat":-25.7461,"lon":28.1881},
      {"id":"rustenburg","name":"Rustenburg","country":"South Africa","lat":-25.6667,"lon":27.2428},
      {"id":"newcastle","name":"Newcastle","country":"South Africa","lat":-27.7464,"lon":29.9328},
      {"id":"eastlondon","name":"East London","country":"South Africa","lat":-33.0175,"lon":27.9047},
      {"id":"katlehong","name":"Katlehong","country":"South Africa","lat":-26.3333,"lon":28.15},
      {"id":"khayelitsha","name":"Khayelitsha","country":"South Africa","lat":-34.0403,"lon":18.6778},
      {"id":"randburg","name":"Randburg","country":"South Africa","lat":-26.0936,"lon":28.0064},
      {"id":"roodepoort","name":"Roodepoort","country":"South Africa","lat":-26.1625,"lon":27.8725},
      {"id":"mitchellsplain","name":"Mitchells Plain","country":"South Africa","lat":-34.0506,"lon":18.6181},
      {"id":"boksburg","name":"Boksburg","country":"South Africa","lat":-26.2125,"lon":28.2625},
      {"id":"bloemfontein","name":"Bloemfontein","country":"South Africa","lat":-29.1167,"lon":26.2167},
      {"id":"germiston","name":"Germiston","country":"South Africa","lat":-26.2178,"lon":28.1672},
      {"id":"centurion","name":"Centurion","country":"South Africa","lat":-25.8603,"lon":28.1894},
      {"id":"kimberley","name":"Kimberley","country":"South Africa","lat":-28.7383,"lon":24.7639},
      {"id":"sandton","name":"Sandton","country":"South Africa","lat":-26.107,"lon":28.0517},
      {"id":"klerksdorp","name":"Klerksdorp","country":"South Africa","lat":-26.8667,"lon":26.6667},
      {"id":"bethelsdorp","name":"Bethelsdorp","country":"South Africa","lat":-33.8833,"lon":25.5},
      {"id":"kemptonpark","name":"Kempton Park","country":"South Africa","lat":-26.1,"lon":28.2333},
      {"id":"nqutu","name":"Nqutu","country":"South Africa","lat":-28.232,"lon":30.566},
      {"id":"kroonstad","name":"Kroonstad","country":"South Africa","lat":-27.65,"lon":27.2333},
      {"id":"benoni","name":"Benoni","country":"South Africa","lat":-26.1883,"lon":28.3206},
      {"id":"george","name":"George","country":"South Africa","lat":-33.9667,"lon":22.45},
      {"id":"potchefstroom","name":"Potchefstroom","country":"South Africa","lat":-26.715,"lon":27.1033},
      {"id":"pinetown","name":"Pinetown","country":"South Africa","lat":-29.8167,"lon":30.85},
      {"id":"krugersdorp","name":"Krugersdorp","country":"South Africa","lat":-26.1,"lon":27.7667},
      {"id":"mthatha","name":"Mthatha","country":"South Africa","lat":-31.58,"lon":28.79},
      {"id":"polokwane","name":"Polokwane","country":"South Africa","lat":-23.9,"lon":29.45},
      {"id":"springs","name":"Springs","country":"South Africa","lat":-26.2547,"lon":28.4428},
      {"id":"alberton","name":"Alberton","country":"South Africa","lat":-26.2672,"lon":28.1219},
      {"id":"upington","name":"Upington","country":"South Africa","lat":-28.45,"lon":21.25},
      {"id":"winterveld","name":"Winterveld","country":"South Africa","lat":-25.42,"lon":27.949},
      {"id":"parow","name":"Parow","country":"South Africa","lat":-33.9,"lon":18.6},
      {"id":"paarl","name":"Paarl","country":"South Africa","lat":-33.7242,"lon":18.9558},
      {"id":"empangeni","name":"Empangeni","country":"South Africa","lat":-28.75,"lon":31.9},
      {"id":"witbank","name":"Witbank","country":"South Africa","lat":-25.877,"lon":29.201},
      {"id":"uitenhage","name":"Uitenhage","country":"South Africa","lat":-33.7667,"lon":25.4},
      {"id":"kwadukuza","name":"KwaDukuza","country":"South Africa","lat":-29.3333,"lon":31.2917},
      {"id":"worcester","name":"Worcester","country":"South Africa","lat":-33.645,"lon":19.4436},
      {"id":"grahamstown","name":"Grahamstown","country":"South Africa","lat":-33.2996,"lon":26.52},
      {"id":"oudtshoorn","name":"Oudtshoorn","country":"South Africa","lat":-33.5833,"lon":22.2},
      {"id":"ermelo","name":"Ermelo","country":"South Africa","lat":-26.5333,"lon":29.9833},
      {"id":"stellenbosch","name":"Stellenbosch","country":"South Africa","lat":-33.9367,"lon":18.8614},
      {"id":"sasolburg","name":"Sasolburg","country":"South Africa","lat":-26.8142,"lon":27.8286},
      {"id":"thabanchu","name":"Thaba Nchu","country":"South Africa","lat":-29.2,"lon":26.8333},
      {"id":"kwamhlanga","name":"Kwamhlanga","country":"South Africa","lat":-25.432,"lon":28.708},
      {"id":"thohoyandou","name":"Thohoyandou","country":"South Africa","lat":-22.95,"lon":30.4833},
      {"id":"queenstown","name":"Queenstown","country":"South Africa","lat":-31.9,"lon":26.8833},
      {"id":"odendaalsrus","name":"Odendaalsrus","country":"South Africa","lat":-27.8667,"lon":26.6833},
      {"id":"bethal","name":"Bethal","country":"South Africa","lat":-26.45,"lon":29.45},
      {"id":"mosselbay","name":"Mossel Bay","country":"South Africa","lat":-34.1833,"lon":22.1333},
      {"id":"wellington","name":"Wellington","country":"South Africa","lat":-33.6333,"lon":18.9833},
      {"id":"queensburgh","name":"Queensburgh","country":"South Africa","lat":-29.8667,"lon":30.9333},
      {"id":"phuthaditjhaba","name":"Phuthaditjhaba","country":"South Africa","lat":-28.5333,"lon":28.8167},
      {"id":"kokstad","name":"Kokstad","country":"South Africa","lat":-30.5539,"lon":29.4269},
      {"id":"edenvale","name":"Edenvale","country":"South Africa","lat":-26.1411,"lon":28.1528},
      {"id":"vryheid","name":"Vryheid","country":"South Africa","lat":-27.7669,"lon":30.8},
      {"id":"kuilsrivier","name":"Kuilsrivier","country":"South Africa","lat":-33.9414,"lon":18.7066},
      {"id":"bothaville","name":"Bothaville","country":"South Africa","lat":-27.3833,"lon":26.6167},
      {"id":"parys","name":"Parys","country":"South Africa","lat":-26.9,"lon":27.45},
      {"id":"grabouw","name":"Grabouw","country":"South Africa","lat":-34.15,"lon":19.0167},
      {"id":"despatch","name":"Despatch","country":"South Africa","lat":-33.8015,"lon":25.4768},
      {"id":"vredenburg","name":"Vredenburg","country":"South Africa","lat":-32.9064,"lon":17.9958},
      {"id":"mmabatho","name":"Mmabatho","country":"South Africa","lat":-25.85,"lon":25.6333},
      {"id":"lydenburg","name":"Lydenburg","country":"South Africa","lat":-25.096,"lon":30.446},
      {"id":"siyabuswa","name":"Siyabuswa","country":"South Africa","lat":-25.1167,"lon":29.05},
      {"id":"namakgale","name":"Namakgale","country":"South Africa","lat":-23.938,"lon":31.028},
      {"id":"malmesbury","name":"Malmesbury","country":"South Africa","lat":-33.45,"lon":18.7333},
      {"id":"lebowakgomo","name":"Lebowakgomo","country":"South Africa","lat":-24.305,"lon":29.565},
      {"id":"phokeng","name":"Phokeng","country":"South Africa","lat":-25.5833,"lon":27.1333},
      {"id":"westville","name":"Westville","country":"South Africa","lat":-29.831,"lon":30.925},
      {"id":"ulundi","name":"Ulundi","country":"South Africa","lat":-28.3167,"lon":31.4167},
      {"id":"mondlo","name":"Mondlo","country":"South Africa","lat":-27.967,"lon":30.722},
      {"id":"saldanha","name":"Saldanha","country":"South Africa","lat":-32.9978,"lon":17.9456},
      {"id":"heilbron","name":"Heilbron","country":"South Africa","lat":-27.2836,"lon":27.9708},
      {"id":"jeffreysbay","name":"Jeffrey‚Äôs Bay","country":"South Africa","lat":-34.0333,"lon":24.9167},
      {"id":"frankfort","name":"Frankfort","country":"South Africa","lat":-27.2833,"lon":28.5167},
      {"id":"giyani","name":"Giyani","country":"South Africa","lat":-23.31,"lon":30.7064},
      {"id":"mathibestad","name":"Mathibestad","country":"South Africa","lat":-25.276,"lon":28.178},
      {"id":"mpophomeni","name":"Mpophomeni","country":"South Africa","lat":-29.567,"lon":30.182},
      {"id":"volksrust","name":"Volksrust","country":"South Africa","lat":-27.3667,"lon":29.8833},
      {"id":"umhlangarocks","name":"uMhlanga Rocks","country":"South Africa","lat":-29.7333,"lon":31.0708},
      {"id":"nkowakowa","name":"Nkowakowa","country":"South Africa","lat":-23.886,"lon":30.293},
      {"id":"robertson","name":"Robertson","country":"South Africa","lat":-33.8,"lon":19.8833},
      {"id":"pampierstad","name":"Pampierstad","country":"South Africa","lat":-27.776,"lon":24.69},
      {"id":"hammanskraal","name":"Hammanskraal","country":"South Africa","lat":-25.4,"lon":28.2833},
      {"id":"bronkhorstspruit","name":"Bronkhorstspruit","country":"South Africa","lat":-25.805,"lon":28.7464},
      {"id":"itsoseng","name":"Itsoseng","country":"South Africa","lat":-26.083,"lon":25.882},
      {"id":"garsfontein","name":"Garsfontein","country":"South Africa","lat":-25.7913,"lon":28.2935},
      {"id":"mooirivier","name":"Mooirivier","country":"South Africa","lat":-29.2,"lon":29.9833},
      {"id":"kingsborough","name":"Kingsborough","country":"South Africa","lat":-30.0833,"lon":30.8667},
      {"id":"turffontein","name":"Turffontein","country":"South Africa","lat":-26.2446,"lon":28.0397},
      {"id":"alice","name":"Alice","country":"South Africa","lat":-32.7892,"lon":26.835},
      {"id":"mahikeng","name":"Mahikeng","country":"South Africa","lat":-25.8656,"lon":25.6436},
      {"id":"breyten","name":"Breyten","country":"South Africa","lat":-26.3,"lon":29.9833},
      {"id":"primrose","name":"Primrose","country":"South Africa","lat":-26.1833,"lon":28.1667},
      {"id":"bedfordview","name":"Bedfordview","country":"South Africa","lat":-26.1794,"lon":28.1361},
      {"id":"emanzimtoti","name":"eManzimtoti","country":"South Africa","lat":-30.05,"lon":30.8833},
      {"id":"kirkwood","name":"Kirkwood","country":"South Africa","lat":-33.4003,"lon":25.4425},
      {"id":"pretorianoord","name":"Pretoria-Noord","country":"South Africa","lat":-25.6731,"lon":28.1733},
      {"id":"elandsdoorn","name":"Elandsdoorn","country":"South Africa","lat":-25.288,"lon":29.196},
      {"id":"buffelshoek","name":"Buffelshoek","country":"South Africa","lat":-24.6308,"lon":31.1383},
      {"id":"groutville","name":"Groutville","country":"South Africa","lat":-29.388,"lon":31.245},
      {"id":"summerstrand","name":"Summerstrand","country":"South Africa","lat":-33.9914,"lon":25.6569},
      {"id":"jeppesreef","name":"Jeppe‚Äôs Reef","country":"South Africa","lat":-25.72,"lon":31.477},
      {"id":"dysselsdorp","name":"Dysselsdorp","country":"South Africa","lat":-33.5667,"lon":22.4333},
      {"id":"matatiele","name":"Matatiele","country":"South Africa","lat":-30.3422,"lon":28.8061},
      {"id":"exobho","name":"eXobho","country":"South Africa","lat":-30.1572,"lon":30.0647},
      {"id":"lenyenye","name":"Lenyenye","country":"South Africa","lat":-23.972,"lon":30.269},
      {"id":"mountfletcher","name":"Mount Fletcher","country":"South Africa","lat":-30.692,"lon":28.503},
      {"id":"gonubie","name":"Gonubie","country":"South Africa","lat":-32.943,"lon":28.008},
      {"id":"mogogelo","name":"Mogogelo","country":"South Africa","lat":-25.354,"lon":28.138},
      {"id":"vaalreefs","name":"Vaal Reefs","country":"South Africa","lat":-26.929,"lon":26.736},
      {"id":"dedoorns","name":"De Doorns","country":"South Africa","lat":-33.4833,"lon":19.6833},
      {"id":"bhisho","name":"Bhisho","country":"South Africa","lat":-32.8494,"lon":27.4381},
      {"id":"langeloop","name":"Langeloop","country":"South Africa","lat":-25.684,"lon":31.635},
      {"id":"ekuvukeni","name":"Ekuvukeni","country":"South Africa","lat":-28.466,"lon":30.157},
      {"id":"velddrif","name":"Velddrif","country":"South Africa","lat":-32.7833,"lon":18.1667},
      {"id":"hartswater","name":"Hartswater","country":"South Africa","lat":-27.7667,"lon":24.8167},
      {"id":"alexandria","name":"Alexandria","country":"South Africa","lat":-33.6533,"lon":26.4083},
      {"id":"gakgapane","name":"Ga-Kgapane","country":"South Africa","lat":-23.649,"lon":30.226},
      {"id":"boekenhouthoek","name":"Boekenhouthoek","country":"South Africa","lat":-25.303,"lon":29.015},
      {"id":"steynsrus","name":"Steynsrus","country":"South Africa","lat":-27.95,"lon":27.5667},
      {"id":"greytown","name":"Greytown","country":"South Africa","lat":-29.0667,"lon":30.5833},
      {"id":"mbuzini","name":"Mbuzini","country":"South Africa","lat":-25.9333,"lon":31.9333},
      {"id":"doornkop","name":"Doornkop","country":"South Africa","lat":-26.2328,"lon":27.7833},
      {"id":"umzimkulu","name":"Umzimkulu","country":"South Africa","lat":-30.263,"lon":29.94},
      {"id":"sedgefield","name":"Sedgefield","country":"South Africa","lat":-34.0214,"lon":22.8033},
      {"id":"hawston","name":"Hawston","country":"South Africa","lat":-34.3833,"lon":19.1333},
      {"id":"buffelspruit","name":"Buffelspruit","country":"South Africa","lat":-25.658,"lon":31.516},
      {"id":"lorraine","name":"Lorraine","country":"South Africa","lat":-33.9725,"lon":25.4981},
      {"id":"saron","name":"Saron","country":"South Africa","lat":-33.181,"lon":19.01},
      {"id":"bosfontein","name":"Bosfontein","country":"South Africa","lat":-25.744,"lon":31.626},
      {"id":"breidbach","name":"Breidbach","country":"South Africa","lat":-32.8833,"lon":27.4333},
      {"id":"welverdiend","name":"Welverdiend","country":"South Africa","lat":-24.581,"lon":31.343},
      {"id":"wolwekraal","name":"Wolwekraal","country":"South Africa","lat":-25.153,"lon":28.961},
      {"id":"citrusdal","name":"Citrusdal","country":"South Africa","lat":-32.5894,"lon":19.0147},
      {"id":"tweeling","name":"Tweeling","country":"South Africa","lat":-27.55,"lon":28.5167},
      {"id":"vanrhynsdorp","name":"Vanrhynsdorp","country":"South Africa","lat":-31.6167,"lon":18.7333},
      {"id":"klawer","name":"Klawer","country":"South Africa","lat":-31.7833,"lon":18.6167},
      {"id":"elsburg","name":"Elsburg","country":"South Africa","lat":-26.245,"lon":28.197},
      {"id":"olifantshoek","name":"Olifantshoek","country":"South Africa","lat":-23.34,"lon":30.277},
      {"id":"genadendal","name":"Genadendal","country":"South Africa","lat":-34.0333,"lon":19.55},
      {"id":"emanguzi","name":"eManguzi","country":"South Africa","lat":-26.996,"lon":32.752},
      {"id":"botrivier","name":"Botrivier","country":"South Africa","lat":-34.2258,"lon":19.205},
      {"id":"oberholzer","name":"Oberholzer","country":"South Africa","lat":-26.347,"lon":27.382},
      {"id":"mountayliff","name":"Mount Ayliff","country":"South Africa","lat":-30.8092,"lon":29.3669},
      {"id":"mountfrere","name":"Mount Frere","country":"South Africa","lat":-30.9167,"lon":28.9833},
      {"id":"riviersonderend","name":"Riviersonderend","country":"South Africa","lat":-34.1503,"lon":19.9144},
      {"id":"kentononsea","name":"Kenton on Sea","country":"South Africa","lat":-33.683,"lon":26.659},
      {"id":"flagstaff","name":"Flagstaff","country":"South Africa","lat":-31.08,"lon":29.5044},
      {"id":"waterkloof","name":"Waterkloof","country":"South Africa","lat":-25.775,"lon":28.2417},
      {"id":"sonop","name":"Sonop","country":"South Africa","lat":-25.648,"lon":27.698},
      {"id":"libode","name":"Libode","country":"South Africa","lat":-31.5333,"lon":29.0167},
      {"id":"bluewaterbay","name":"Bluewater Bay","country":"South Africa","lat":-33.8567,"lon":25.6294},
      {"id":"riebeekwes","name":"Riebeek-Wes","country":"South Africa","lat":-33.3505,"lon":18.8674},
      {"id":"sibasa","name":"Sibasa","country":"South Africa","lat":-22.932,"lon":30.467},
      {"id":"uvongobeach","name":"Uvongo Beach","country":"South Africa","lat":-30.8167,"lon":30.3833},
      {"id":"sandbaai","name":"Sandbaai","country":"South Africa","lat":-34.419,"lon":19.194},
      {"id":"lusikisiki","name":"Lusikisiki","country":"South Africa","lat":-31.368,"lon":29.576},
      {"id":"chrissiesmeer","name":"Chrissiesmeer","country":"South Africa","lat":-26.278,"lon":30.213},
      {"id":"schulzendal","name":"Schulzendal","country":"South Africa","lat":-25.749,"lon":31.54},
      {"id":"rooiboklaagte","name":"Rooiboklaagte","country":"South Africa","lat":-24.655,"lon":31.067},
      {"id":"madikwe","name":"Madikwe","country":"South Africa","lat":-25.355,"lon":26.53},
      {"id":"malelane","name":"Malelane","country":"South Africa","lat":-25.4833,"lon":31.5167},
      {"id":"warnerbeach","name":"Warner Beach","country":"South Africa","lat":-30.085,"lon":30.862},
      {"id":"richmond","name":"Richmond","country":"South Africa","lat":-29.8667,"lon":30.2667},
      {"id":"shakaskraal","name":"Shakaskraal","country":"South Africa","lat":-29.45,"lon":31.2167},
      {"id":"newhanover","name":"New Hanover","country":"South Africa","lat":-29.35,"lon":30.5333},
      {"id":"komaggas","name":"Komaggas","country":"South Africa","lat":-29.8,"lon":17.5},
      {"id":"rawsonville","name":"Rawsonville","country":"South Africa","lat":-33.6847,"lon":19.315},
      {"id":"gannalaagte","name":"Gannalaagte","country":"South Africa","lat":-26.464,"lon":25.53},
      {"id":"fontainebleau","name":"Fontainebleau","country":"South Africa","lat":-26.1037,"lon":27.9766},
      {"id":"sheepmoor","name":"Sheepmoor","country":"South Africa","lat":-26.7186,"lon":30.2989},
      {"id":"lesseyton","name":"Lesseyton","country":"South Africa","lat":-31.833,"lon":26.766},
      {"id":"ngqeleni","name":"Ngqeleni","country":"South Africa","lat":-31.67,"lon":29.028},
      {"id":"roossenekal","name":"Roossenekal","country":"South Africa","lat":-25.195,"lon":29.925},
      {"id":"doonside","name":"Doonside","country":"South Africa","lat":-30.07,"lon":30.871},
      {"id":"abbotspoort","name":"Abbotspoort","country":"South Africa","lat":-23.453,"lon":28.093},
      {"id":"hlabisa","name":"Hlabisa","country":"South Africa","lat":-28.1333,"lon":31.8667},
      {"id":"nelspruit","name":"Nelspruit","country":"South Africa","lat":-25.4745,"lon":30.9703}
    ];

    const cities = [...baseCities, ...southAfricaCities];

    // =========================
    // Map setup
    // =========================
    const map = L.map("map").setView([20, 0], 2);

    L.tileLayer(theme.tileUrl, {
      maxZoom: 8,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);

    // =========================
    // Weather helpers
    // =========================
    const weatherCache = {}; // { cityId: { info, timestamp } }
    const CACHE_MS = 10 * 60 * 1000; // 10 minutes

    function getWeatherEmoji(info) {
      const snow = info.snowfall || 0;
      const rain = info.rain || info.precipitation || 0;

      if (snow > 0.05) return { emoji: "‚ùÑÔ∏è", label: "Snowing" };
      if (rain > 0.05) return { emoji: "üåßÔ∏è", label: "Raining" };
      return { emoji: "‚òÅÔ∏è", label: "No rain/snow" };
    }

    async function fetchWeather(city) {
      const cached = weatherCache[city.id];
      const now = Date.now();

      if (cached && now - cached.timestamp < CACHE_MS) {
        return cached.info;
      }

      const url =
        "https://api.open-meteo.com/v1/forecast" +
        `?latitude=${city.lat}` +
        `&longitude=${city.lon}` +
        "&hourly=precipitation,rain,snowfall,temperature_2m" +
        "&forecast_days=1&timezone=auto";

      const res = await fetch(url);
      if (!res.ok) throw new Error("Network error " + res.status);
      const data = await res.json();

      const h = data.hourly;
      const info = {
        time: h.time[0],
        precipitation: h.precipitation[0],
        rain: h.rain ? h.rain[0] : 0,
        snowfall: h.snowfall ? h.snowfall[0] : 0,
        temp: h.temperature_2m ? h.temperature_2m[0] : null,
      };

      weatherCache[city.id] = { info, timestamp: now };
      return info;
    }

    // =========================
    // Info card updater
    // =========================
    const infoEmojiEl = document.getElementById("infoEmoji");
    const infoCityEl = document.getElementById("infoCity");
    const infoStatusEl = document.getElementById("infoStatus");
    const infoTempEl = document.getElementById("infoTemp");
    const infoFeelsEl = document.getElementById("infoFeels");

    function updateInfoCard(city, info) {
      const { emoji, label } = getWeatherEmoji(info);
      infoEmojiEl.textContent = emoji;
      infoCityEl.textContent = `${city.name}, ${city.country}`;
      infoStatusEl.textContent = `${label} ‚Ä¢ ${info.time}`;
      if (info.temp != null) {
        const t = info.temp.toFixed(1);
        infoTempEl.textContent = `${t}¬∞C`;
        infoFeelsEl.textContent = `Feels like ${t}¬∞`;
      } else {
        infoTempEl.textContent = "--¬∞C";
        infoFeelsEl.textContent = "Feels like --";
      }
    }

    // =========================
    // Add city markers with live weather
    // =========================
    async function loadCityMarkers() {
      markersLayer.clearLayers();

      for (const city of cities) {
        try {
          const info = await fetchWeather(city);
          const { emoji, label } = getWeatherEmoji(info);

          const icon = L.divIcon({
            className: "",
            html:
              '<div class="marker-badge">' +
              emoji +
              "</div>",
            iconSize: [30, 30],
            iconAnchor: [15, 15],
          });

          const popupHtml =
            `<div style="font-size:0.85rem;">` +
            `<div style="font-weight:600;margin-bottom:4px;">${city.name} (${city.country})</div>` +
            `<div style="display:flex;align-items:center;gap:6px;">` +
            `<span style="font-size:1.3rem;">${emoji}</span>` +
            `<span>${label}</span>` +
            `</div>` +
            `<div style="margin-top:4px;opacity:0.8;">` +
            `Temp: ${
              info.temp != null ? info.temp.toFixed(1) + "¬∞C" : "N/A"
            }<br/>` +
            `Precipitation: ${info.precipitation.toFixed(2)} mm<br/>` +
            `Snowfall: ${info.snowfall.toFixed(2)} cm<br/>` +
            `Time: ${info.time}` +
            `</div>` +
            `</div>`;

          const marker = L.marker([city.lat, city.lon], { icon }).addTo(
            markersLayer
          );

          marker.bindPopup(popupHtml);

          marker.on("click", () => {
            updateInfoCard(city, info);
          });
        } catch (err) {
          console.error("Weather error for", city.name, err);
        }
      }
    }

    loadCityMarkers();

    // =========================
    // UI buttons: zoom + locate + search + focus
    // =========================
    document
      .getElementById("btnZoomIn")
      .addEventListener("click", () => map.zoomIn());
    document
      .getElementById("btnZoomOut")
      .addEventListener("click", () => map.zoomOut());

    document.getElementById("btnLocate").addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Geolocation not supported in this browser.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 6);
        },
        () => {
          alert("Unable to get your location.");
        }
      );
    });

    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const q = searchInput.value.trim().toLowerCase();
        if (!q) return;
        const city = cities.find((c) =>
          c.name.toLowerCase().includes(q)
        );
        if (city) {
          map.setView([city.lat, city.lon], 7);
        } else {
          alert("City not in the demo list. Add it to the cities array in JS.");
        }
      }
    });

    // Quick focus chips
    document.getElementById("focusWorld").addEventListener("click", () => {
      map.setView([20, 0], 2);
    });

    document.getElementById("focusSA").addEventListener("click", () => {
      // Rough center over South Africa
      map.setView([-29, 25], 5);
    });

    document.getElementById("focusIndia").addEventListener("click", () => {
      map.setView([22.5, 79], 5);
    });
  </script>
</body>
</html>
